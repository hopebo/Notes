# 关于程序设计技巧

### 确保代码覆盖率

Developers should make sure that they include unit tests and MTR tests that give full coverage for their patches.  Some tips for MTR tests:

- If you wonder about which existing tests cover the code you are changing,  add some DBUG_ASSERT(false) to the relevant code, and run the full test suite.  Record which tests fail, and use this subset of tests when testing your code.
- For testing coverage, use gcov (supported by Jenkins), or use a "poor man's alternative":   Add DBUG_ASSERT(false) to interesting code paths, run your new tests, remove the assert that is hit, and repeat until no failure.  Remaining asserts are not covered by your tests.  Maybe someone can automate this process by writing a program that: 1. runs test, 2. finds asserting line in error log, 3. removes the assert at that line, and 4. repeats until no more failure.  (I do not think we can expect full coverage for error handling)
- Full coverage is good, but not perfect.  Ideally, changing any line in your patch should lead to a test failure. When I am reviewing a patch, and suspect low test coverage of some code, I try to change individual lines and see if a test fails.  (I also learn more about the purpose of the code this way.) . Types of changes can be:  Delete line, always execute if-block, always execute else-block, change while to if, change return value, change parameter value, and so on.  If no test fails, I ask for more test coverage.  This work is a bit time consuming to do for review, so it would be better if developers ensured this themselves.  (Note that changing some code lines will only affect performance, not functional behavior.  In those cases, it may not be possible to show test changes unless it is possible to add some performance metrics that will show this.)