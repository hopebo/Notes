# 值班手册
## 登陆命令
登陆跳板机 `ssh hope.lb@login1.am100.alibaba-inc.com` 或者 `ssh hope.lb@login1.am101.alibaba-inc.com`.

## Docker 命令
### 进入 Docker
`docker exec -it [docker id] bash`
### 查看进程
`docker ps | grep [instance name]`
### 快速根据端口号进入 Docker
```shell
# 根据端口号快速登陆 docker 实例
PORT=3040
docker exec -it $(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.ID}}' | grep $(ps auxf | grep mysqld | grep -B 1 $PORT | grep safe | grep -v grep | awk '{print $2}') | awk -F, '{print $2}') bash
```

## OSS 操作
```shell
# ossutil
ossutil ls oss://sqltest-oss/ -i LTAI4FoPBRfqudKxmwLNYqKF -k IurnHiynXx0in8EZrdNJJuCvJ8PDxc -e http://oss-cn-hangzhou.aliyuncs.com
ossutil cp example.sql oss://sqltest-oss/ -i LTAI4FoPBRfqudKxmwLNYqKF -k IurnHiynXx0in8EZrdNJJuCvJ8PDxc -e http://oss-cn-hangzhou.aliyuncs.com

# osscmd
osscmd put example.sql oss://sqltest-oss/ -i LTAI4FoPBRfqudKxmwLNYqKF -k IurnHiynXx0in8EZrdNJJuCvJ8PDxc -H oss-cn-hangzhou.aliyuncs.com
osscmd get oss://sqltest-oss/example.sql /tmp -i LTAI4FoPBRfqudKxmwLNYqKF -k IurnHiynXx0in8EZrdNJJuCvJ8PDxc -H oss-cn-hangzhou.aliyuncs.com
```

## MySQL 登陆
```shell
/usr/bin/mysql_secbox --exe-path=/usr/bin/mysql -A -ualiyun_root -h127.0.0.1 -P3001

mysql -A -ualiyun_root -h127.0.0.1 -P3002

my 3002
```

## 查看审计日志目录
`show status like 'rds_audit_log_filename';`

## 清理 slow log
`truncate mysql.slow_log;`

## 判断 OOM
```shell
cat /var/log/messages | grep oom-killer
dmesg | grep oom
```

## Too many connections
### 打印和设置当前连接数
```shell
gdb -ex "p Connection_handler_manager::m_instance.rds_reserved_connection_count" -batch -p <pid>
gdb -ex "set Connection_handler_manager::m_instance.rds_reserved_connection_count+=50" -batch -p <pid>
```

## 文件大小排序
`du -sh * | sort -h`

## 只读延迟很大
```mysql
show processlist;
stop slave; start slave;
```
